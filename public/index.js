(()=>{"use strict";class e extends EventTarget{constructor(){super(),this.dict={q:57,w:59,e:60,r:62,t:64,y:65,u:67,i:69},this.pressed={q:!1,w:!1,e:!1,r:!1,t:!1,y:!1,u:!1,i:!1},this.keyDown=e=>{void 0!==this.pressed[e.key]&&(this.pressed[e.key]||(this.dispatchEvent(new CustomEvent("noteOn",{detail:{noteNumber:this.dict[e.key]}})),this.pressed[e.key]=!0))},this.keyUp=e=>{void 0!==this.pressed[e.key]&&(this.dispatchEvent(new CustomEvent("noteOff",{detail:{noteNumber:this.dict[e.key]}})),this.pressed[e.key]=!1)},window.addEventListener("keydown",this.keyDown),window.addEventListener("keyup",this.keyUp)}}class t extends OscillatorNode{constructor(e,t,n){super(e),this.setVolume=e=>{this.gain.gain.value=e},this.setDelay=(e,t)=>{e=Math.max(0,Math.min(e,1)),this.delay.delayTime.value=e/t},this.type=t,this.gain=e.createGain(),this.gain.connect(n),this.delay=e.createDelay(),this.delay.connect(this.gain),this.connect(this.delay)}}class n{constructor(e){this.setDestination=e=>{this.destination=e,this.outputNode.disconnect(),this.outputNode.connect(e)},this.noteOn=e=>{let t=this.generateVoices(n.noteNumberToFrequency(e));for(let e of t)e.start();this.voices.set(e,t)},this.noteOff=e=>{let t=this.voices.get(e);if(t)for(let e of t)e.stop();this.voices.delete(e)},this.setMasterVolume=e=>{this.masterGain.gain.value=e},this.setVolume=(e,t)=>{if(void 0===this.waveforms.get(e))throw new Error(`waveform ${e} doesn't exist`);this.waveforms.get(e).volume=t},this.setDelay=(e,t)=>{if(void 0===this.waveforms.get(e))throw new Error(`waveform ${e} doesn't exist`);this.waveforms.get(e).delay=t},this.setWaveType=(e,t)=>{if(void 0===this.waveforms.get(e))throw new Error(`waveform ${e} doesn't exist`);this.waveforms.get(e).type=t},this.addWaveform=(e,t)=>{this.waveforms.set(e,t)},this.removeWaveform=e=>{if(void 0===this.waveforms.get(e))throw new Error(`waveform ${e} doesn't exist`);this.waveforms.delete(e)},this.generateVoices=e=>{let n=[];return this.waveforms.forEach((s=>{if(s.type){let i=new t(this.context,s.type,this.masterGain);i.setVolume(s.volume),i.setDelay(s.delay,e),i.frequency.value=e,n.push(i)}})),n},this.context=e,this.voices=new Map,this.waveforms=new Map,this.destination=e.destination,this.compressor=this.context.createDynamicsCompressor(),this.compressor.connect(this.destination),this.outputNode=this.compressor,this.masterGain=this.context.createGain(),this.masterGain.connect(this.compressor)}setCompressorOn(e){this.compressor.disconnect(),this.masterGain.disconnect(),e?(this.compressor.connect(this.destination),this.masterGain.connect(this.compressor)):this.masterGain.connect(this.destination)}}n.noteNumberToFrequency=e=>440*Math.pow(2,(e-69)/12);const s=document.getElementById("MIDI_Input_sel"),i=document.getElementById("add_waveform_btn"),a=document.getElementById("waveforms"),o=document.getElementById("masterVolume"),r=document.getElementById("compressorToggle"),c=document.getElementById("oscillatorToggle"),h=document.getElementById("oscillatorCanvas"),d=new window.AudioContext,l=new n(d),m=new class{constructor(e,t){this.setDestination=e=>{this.analyser.disconnect(),e?this.analyser.connect(e):this.analyser.connect(this.analyser.context.destination)},this.disconnect=()=>{this.analyser.disconnect()},this.setFrequency=e=>{this.frequency=e},this.drawStop=()=>{this.animFrameId&&(cancelAnimationFrame(this.animFrameId),this.animFrameId=null)},this.drawStart=()=>{this.drawPlot(),this.animFrameId=requestAnimationFrame(this.drawStart)},this.drawPlot=()=>{this.analyser.getByteTimeDomainData(this.dataArray),this.canvasCtx.fillStyle="rgb(200, 200, 200)",this.canvasCtx.fillRect(0,0,this.canvas.width,this.canvas.height),this.canvasCtx.lineWidth=2,this.canvasCtx.strokeStyle="rgb(0, 0, 0)",this.canvasCtx.beginPath();const e=this.dataArray.length,t=this.canvas.width/e;let n=this.analyser.context.sampleRate,s=n/this.frequency,i=n*this.analyser.context.currentTime%s;for(let n=0;n<e;n++){let e=this.canvas.width-(n+i)*t,s=this.dataArray[n]/128*this.canvas.height/2;0===n?this.canvasCtx.moveTo(e,s):this.canvasCtx.lineTo(e,s)}this.canvasCtx.stroke()},this.analyser=e.createAnalyser(),this.analyser.fftSize=1024;let n=this.analyser.frequencyBinCount;if(this.dataArray=new Uint8Array(n),this.canvas=t,!t.getContext("2d"))throw new Error("Get canvas context error");this.canvasCtx=t.getContext("2d"),this.canvasCtx.clearRect(0,0,this.canvas.width,this.canvas.height),this.frequency=220,this.animFrameId=null}}(d,h),u=new class{constructor(){this.getInputs=()=>{if(this.midiAccess)return this.midiAccess.inputs;throw new Error("No MIDI access")},this.setSelectedInput=e=>{let t=this.getInputs().get(e);void 0===t?this.setActiveInput(null):this.setActiveInput(t)},this.setActiveInput=e=>{this.activeInput&&(this.activeInput.onmidimessage=()=>{}),this.activeInput=e,this.activeInput&&(this.activeInput.onmidimessage=this.onMIDIMessage)},this.onMIDIMessage=e=>{switch(240&e.data[0]){case 144:0!==e.data[2]&&this.eventTarget.dispatchEvent(new CustomEvent("noteOn",{detail:{noteNumber:e.data[1]}}));break;case 128:this.eventTarget.dispatchEvent(new CustomEvent("noteOff",{detail:{noteNumber:e.data[1]}}))}},this.onstatechange=e=>{let t=e.port;"input"===t.type&&("open"===t.connection?this.updateInputSelect():"closed"==t.connection&&this.activeInput&&e.port.id===this.activeInput.id&&this.setActiveInput(null),this.updateInputSelect())},this.updateInputSelect=()=>{for(let e=this.midiInputSelectElem.options.length-1;e>=1;--e)this.midiInputSelectElem.options.remove(e);for(let e of Array.from(this.getInputs().values())){let t=document.createElement("option");e.name?t.text=e.name:t.text=e.id,t.value=e.id,this.activeInput&&this.activeInput.id===e.id&&(t.defaultSelected=!0),this.midiInputSelectElem.add(t)}},this.midiAccess=null,this.midiInputSelectElem=null,this.activeInput=null,this.eventTarget=new EventTarget}init(e){return t=this,n=void 0,i=function*(){try{this.midiAccess=yield navigator.requestMIDIAccess(),console.log("MIDI access gained"),this.midiInputSelectElem=e,this.updateInputSelect(),this.midiAccess.onstatechange=this.onstatechange}catch(e){console.error("MIDI access rejected "+e)}},new((s=void 0)||(s=Promise))((function(e,a){function o(e){try{c(i.next(e))}catch(e){a(e)}}function r(e){try{c(i.throw(e))}catch(e){a(e)}}function c(t){var n;t.done?e(t.value):(n=t.value,n instanceof s?n:new s((function(e){e(n)}))).then(o,r)}c((i=i.apply(t,n||[])).next())}));var t,n,s,i}};u.init(s),u.eventTarget.addEventListener("noteOn",p),u.eventTarget.addEventListener("noteOff",f);const v=new e;function p(e){l.noteOn(e.detail.noteNumber),m.setFrequency(n.noteNumberToFrequency(e.detail.noteNumber))}function f(e){l.noteOff(e.detail.noteNumber)}function y(){if("masterVolume"===this.id)l.setMasterVolume(Number(this.value));else{let e=this.parentElement.parentElement.id;l.setVolume(Number(e),Number(this.value))}}function w(){let e=this.parentElement.parentElement.id;l.setDelay(Number(e),Number(this.value))}function g(){let e=this.parentElement.parentElement.id;l.setWaveType(Number(e),this.value)}function E(){let e=this.parentElement.parentElement;l.removeWaveform(Number(e.id)),a.removeChild(e)}v.addEventListener("noteOn",p),v.addEventListener("noteOff",f),window.addEventListener("click",(function e(){d.resume().then((()=>{console.log("Audio context resumed successfully"),window.removeEventListener("click",e)}))})),s.addEventListener("change",(function(){u.setSelectedInput(s.value)})),i.addEventListener("click",(function(){let e=a.lastElementChild,t=function(e){let t=document.createElement("tr");t.id=e.toString();let n=document.createElement("td"),s=document.createElement("select");(function(e){let t=["square","sawtooth","triangle","sine"];for(let n of t){let t=document.createElement("option");t.text=n,t.value=n,e.add(t)}})(s),s.addEventListener("change",g),n.append(s);let i=document.createElement("td"),a=document.createElement("input");a.type="range",a.min="0",a.max="1",a.step="0.01",a.value="0.5",a.addEventListener("change",y),i.append(a);let o=document.createElement("td"),r=document.createElement("input");r.type="range",r.min="0",r.max="1",r.step="0.01",r.value="0",r.addEventListener("change",w),o.append(r);let c=document.createElement("td"),h=document.createElement("button");return h.appendChild(document.createTextNode("remove")),h.addEventListener("click",E),c.append(h),t.appendChild(n),t.appendChild(i),t.appendChild(o),t.appendChild(c),t}(e?Number(e.id)+1:0);a.appendChild(t),l.addWaveform(Number(t.id),{type:"square",volume:.5,delay:0})})),o.addEventListener("change",y),r.addEventListener("change",(function(){l.setCompressorOn(this.checked)})),c.addEventListener("change",(function(){this.checked?(l.setDestination(m.analyser),m.setDestination(),m.drawStart(),h.hidden=!1):(m.drawStop(),m.disconnect(),l.setDestination(d.destination),h.hidden=!0)}))})();