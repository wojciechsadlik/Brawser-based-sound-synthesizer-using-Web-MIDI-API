(()=>{"use strict";class e extends OscillatorNode{constructor(e,t){super(e),this.setVolume=e=>{this.gain.gain.value=e},this.gain=e.createGain(),this.gain.connect(e.destination),this.connect(this.gain),this.type=t}}class t{constructor(){this.volume=0,this.type=null}}const n=document.getElementById("MIDI_Input_sel"),i=document.getElementById("add_waveform_btn"),s=document.getElementById("waveforms"),o=new window.AudioContext,c=new class{constructor(t){this.noteOn=e=>{let t=this.generateVoices(this.noteNumberToFrequency(e));for(let e of t)e.start();this.voices.set(e,t)},this.noteOff=e=>{let t=this.voices.get(e);if(t)for(let e of t)e.stop();this.voices.delete(e)},this.setVolume=(e,t)=>{if(!this.waveforms[e])throw new Error("waveform doesn't exist");this.waveforms[e].volume=t},this.setWaveType=(e,t)=>{if(!this.waveforms[e])throw new Error("waveform doesn't exist");this.waveforms[e].type=t},this.addWaveform=e=>{this.waveforms.push(e)},this.removeWaveform=e=>{if(!this.waveforms[e])throw new Error("waveform doesn't exist");this.waveforms.splice(e,1)},this.generateVoices=t=>{let n=[];for(let i of this.waveforms)if(i.type){let s=new e(this.context,i.type);s.setVolume(i.volume),s.frequency.value=t,n.push(s)}return n},this.noteNumberToFrequency=e=>440*Math.pow(2,(e-69)/12),this.context=t,this.voices=new Map,this.waveforms=[]}}(o);window.addEventListener("click",(function e(){o.resume().then((()=>{console.log("Audio context resumed successfully"),window.removeEventListener("click",e)}))}));const a=new class{constructor(){this.getInputs=()=>{if(this.midiAccess)return this.midiAccess.inputs;throw new Error("No MIDI access")},this.setSelectedInput=e=>{let t=this.getInputs().get(e);if(void 0===t?this.setActiveInput(null):this.setActiveInput(t),!t)throw new Error(e+" inputId doesn't match")},this.connectSoundGenerator=e=>{this.soundGenerator=e},this.setActiveInput=e=>{this.activeInput&&(this.activeInput.onmidimessage=()=>{}),this.activeInput=e||null,this.activeInput&&(this.activeInput.onmidimessage=this.onMIDIMessage)},this.onMIDIMessage=e=>{var t,n;switch(240&e.data[0]){case 144:0!==e.data[2]&&(null===(t=this.soundGenerator)||void 0===t||t.noteOn(e.data[1]));break;case 128:null===(n=this.soundGenerator)||void 0===n||n.noteOff(e.data[1])}},this.onstatechange=e=>{this.activeInput&&e.port.id===this.activeInput.id&&this.setActiveInput(null),this.updateInputSelect()},this.updateInputSelect=()=>{for(let e=this.midiInputSelectElem.options.length-1;e>=1;--e)this.midiInputSelectElem.options.remove(e);for(let e of Array.from(this.getInputs().values())){let t=document.createElement("option");e.name?t.text=e.name:t.text=e.id,t.value=e.id,this.midiInputSelectElem.add(t)}},this.midiAccess=null,this.midiInputSelectElem=null,this.activeInput=null,this.soundGenerator=null}init(e){return t=this,n=void 0,s=function*(){try{this.midiAccess=yield navigator.requestMIDIAccess(),console.log("MIDI access gained"),this.midiInputSelectElem=e,this.updateInputSelect(),this.midiAccess.onstatechange=this.onstatechange}catch(e){console.error("MIDI access rejected "+e)}},new((i=void 0)||(i=Promise))((function(e,o){function c(e){try{r(s.next(e))}catch(e){o(e)}}function a(e){try{r(s.throw(e))}catch(e){o(e)}}function r(t){var n;t.done?e(t.value):(n=t.value,n instanceof i?n:new i((function(e){e(n)}))).then(c,a)}r((s=s.apply(t,n||[])).next())}));var t,n,i,s}};function r(){c.setVolume(Number(this.parentElement.id),Number(this.value))}function u(){c.setWaveType(Number(this.parentElement.id),this.value)}function l(){s.removeChild(this.parentNode)}a.init(n),a.connectSoundGenerator(c),n.addEventListener("change",(function(){a.setSelectedInput(n.value)})),i.addEventListener("click",(function(){let e=function(e){let t=document.createElement("div");t.id=e.toString();let n=document.createElement("select");(function(e){let t=["square","sawtooth","triangle","sine"];for(let n of t){let t=document.createElement("option");t.text=n,t.value=n,e.add(t)}})(n),n.addEventListener("change",u);let i=document.createElement("input");i.type="range",i.min="0",i.max="1",i.step="0.01",i.value="0.5",i.addEventListener("change",r);let s=document.createElement("button");return s.appendChild(document.createTextNode("remove")),s.addEventListener("click",l),t.appendChild(n),t.appendChild(i),t.appendChild(s),t}(s.childElementCount);s.appendChild(e);let n=new t;n.type="square",n.volume=.5,c.addWaveform(n)}))})();