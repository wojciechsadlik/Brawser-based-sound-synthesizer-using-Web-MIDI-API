(()=>{"use strict";class e extends Event{constructor(e,t){super("noteOn"),this.noteNumber=e,this.velocity=t}}class t extends Event{constructor(e,t){super("noteOff"),this.noteNumber=e,this.velocity=t}}class s extends EventTarget{constructor(){super(),this.init=e=>{return t=this,s=void 0,i=function*(){try{this.midiAccess=yield navigator.requestMIDIAccess(),console.log("MIDI access gained"),this.midiInputSelectElem=e,this.updateInputSelect(),this.midiAccess.onstatechange=this.onstatechange}catch(e){console.error("MIDI access rejected "+e)}},new((n=void 0)||(n=Promise))((function(e,a){function o(e){try{c(i.next(e))}catch(e){a(e)}}function r(e){try{c(i.throw(e))}catch(e){a(e)}}function c(t){var s;t.done?e(t.value):(s=t.value,s instanceof n?s:new n((function(e){e(s)}))).then(o,r)}c((i=i.apply(t,s||[])).next())}));var t,s,n,i},this.getInputs=()=>{if(this.midiAccess)return this.midiAccess.inputs;throw new Error("No MIDI access")},this.setSelectedInput=e=>{let t=this.getInputs().get(e);void 0===t?this.setActiveInput(null):this.setActiveInput(t)},this.setActiveInput=e=>{this.activeInput&&(this.activeInput.onmidimessage=()=>{}),this.activeInput=e,this.activeInput&&(this.activeInput.onmidimessage=this.onMIDIMessage)},this.onMIDIMessage=s=>{switch(240&s.data[0]){case 144:0!==s.data[2]&&this.dispatchEvent(new e(s.data[1],s.data[2]));break;case 128:this.dispatchEvent(new t(s.data[1],s.data[2]))}},this.onstatechange=e=>{let t=e.port;"input"===t.type&&("disconnected"===t.state&&this.activeInput&&e.port.id===this.activeInput.id&&this.setActiveInput(null),this.updateInputSelect())},this.updateInputSelect=()=>{for(let e=this.midiInputSelectElem.options.length-1;e>=1;--e)this.midiInputSelectElem.options.remove(e);for(let e of Array.from(this.getInputs().values())){let t=document.createElement("option");e.name?t.text=e.name:t.text=e.id,t.value=e.id,this.activeInput&&this.activeInput.id===e.id&&(t.defaultSelected=!0),this.midiInputSelectElem.add(t)}},this.midiAccess=null,this.midiInputSelectElem=null,this.activeInput=null}}class n extends EventTarget{constructor(){super(),this.dict={q:57,w:59,e:60,r:62,t:64,y:65,u:67,i:69,o:71,p:72},this.pressed={q:!1,w:!1,e:!1,r:!1,t:!1,y:!1,u:!1,i:!1,o:!1,p:!1},this.keyDown=t=>{void 0!==this.pressed[t.key]&&(this.pressed[t.key]||(this.dispatchEvent(new e(this.dict[t.key],125)),this.pressed[t.key]=!0))},this.keyUp=e=>{void 0!==this.pressed[e.key]&&(this.dispatchEvent(new t(this.dict[e.key],125)),this.pressed[e.key]=!1)},window.addEventListener("keydown",this.keyDown),window.addEventListener("keyup",this.keyUp)}}class i extends OscillatorNode{constructor(e,t,s){super(e),this.setVolume=e=>{this.gain.gain.value=e},this.setDelay=(e,t)=>{e=Math.max(0,Math.min(e,1)),this.delay.delayTime.value=e/t},this.type=t,this.gain=e.createGain(),this.gain.connect(s),this.delay=e.createDelay(),this.delay.connect(this.gain),this.connect(this.delay)}}class a{constructor(e){this.setDestination=e=>{this.destination=e,this.outputNode.disconnect(),this.outputNode.connect(e)},this.setCompressorOn=e=>{this.compressor.disconnect(),this.masterGain.disconnect(),e?(this.compressor.connect(this.destination),this.masterGain.connect(this.compressor)):this.masterGain.connect(this.destination)},this.noteOn=(e,t)=>{let s=this.generateVoices(a.noteNumberToFrequency(e),t);for(let e of s)e.start();this.voices.set(e,s)},this.noteOff=e=>{let t=this.voices.get(e);if(t)for(let e of t)e.stop();this.voices.delete(e)},this.setMasterVolume=e=>{this.masterGain.gain.value=e},this.setVolume=(e,t)=>{if(void 0===this.waveforms.get(e))throw new Error(`waveform ${e} doesn't exist`);this.waveforms.get(e).volume=t},this.setDelay=(e,t)=>{if(void 0===this.waveforms.get(e))throw new Error(`waveform ${e} doesn't exist`);this.waveforms.get(e).delay=t},this.setWaveType=(e,t)=>{if(void 0===this.waveforms.get(e))throw new Error(`waveform ${e} doesn't exist`);this.waveforms.get(e).type=t},this.addWaveform=(e,t)=>{this.waveforms.set(e,t)},this.removeWaveform=e=>{if(void 0===this.waveforms.get(e))throw new Error(`waveform ${e} doesn't exist`);this.waveforms.delete(e)},this.generateVoices=(e,t)=>{let s=[];return this.waveforms.forEach((n=>{if(n.type){let a=new i(this.context,n.type,this.masterGain);a.setVolume(n.volume*t),a.setDelay(n.delay,e),a.frequency.value=e,s.push(a)}})),s},this.context=e,this.voices=new Map,this.waveforms=new Map,this.destination=e.destination,this.compressor=this.context.createDynamicsCompressor(),this.compressor.threshold.value=-32,this.compressor.connect(this.destination),this.outputNode=this.compressor,this.masterGain=this.context.createGain(),this.masterGain.connect(this.compressor)}}a.noteNumberToFrequency=e=>440*Math.pow(2,(e-69)/12);const o=document.getElementById("MIDI_Input_sel"),r=document.getElementById("add_waveform_btn"),c=document.getElementById("waveforms"),h=document.getElementById("dynamicKeyboardCheckbox"),d=document.getElementById("masterVolume"),l=document.getElementById("compressorCheckbox"),m=document.getElementById("oscilloscopeCheckbox"),u=document.getElementById("oscilloscopeCanvas"),p=new window.AudioContext,v=new a(p),y=new class{constructor(e,t){this.setDestination=e=>{this.analyser.disconnect(),e?this.analyser.connect(e):this.analyser.connect(this.analyser.context.destination)},this.disconnect=()=>{this.analyser.disconnect()},this.setFrequency=e=>{this.frequency=e},this.drawStop=()=>{this.animFrameId&&(cancelAnimationFrame(this.animFrameId),this.animFrameId=null)},this.drawStart=()=>{this.drawPlot(),this.animFrameId=requestAnimationFrame(this.drawStart)},this.drawPlot=()=>{this.analyser.getByteTimeDomainData(this.dataArray),this.canvasCtx.fillStyle="rgb(200, 200, 200)",this.canvasCtx.fillRect(0,0,this.canvas.width,this.canvas.height),this.canvasCtx.lineWidth=2,this.canvasCtx.strokeStyle="rgb(0, 0, 0)",this.canvasCtx.beginPath();const e=this.dataArray.length,t=this.canvas.width/e;let s=this.analyser.context.sampleRate,n=s/this.frequency,i=s*this.analyser.context.currentTime%n;for(let s=0;s<e;s++){let e=this.canvas.width-(s+i)*t,n=this.dataArray[s]/128*this.canvas.height/2;0===s?this.canvasCtx.moveTo(e,n):this.canvasCtx.lineTo(e,n)}this.canvasCtx.stroke()},this.analyser=e.createAnalyser(),this.analyser.fftSize=1024;let s=this.analyser.frequencyBinCount;if(this.dataArray=new Uint8Array(s),this.canvas=t,!t.getContext("2d"))throw new Error("Get canvas context error");this.canvasCtx=t.getContext("2d"),this.canvasCtx.clearRect(0,0,this.canvas.width,this.canvas.height),this.frequency=220,this.animFrameId=null}}(p,u),f=new s;f.init(o),f.addEventListener("noteOn",E),f.addEventListener("noteOff",g);const w=new n;function E(e){let t=1;h.checked&&(t=e.velocity/125),v.noteOn(e.noteNumber,t),y.setFrequency(a.noteNumberToFrequency(e.noteNumber))}function g(e){v.noteOff(e.noteNumber)}function I(){if("masterVolume"===this.id)v.setMasterVolume(Number(this.value));else{let e=this.parentElement.parentElement.id;v.setVolume(Number(e),Number(this.value))}}function x(){let e=this.parentElement.parentElement.id;v.setDelay(Number(e),Number(this.value))}function C(){let e=this.parentElement.parentElement.id;v.setWaveType(Number(e),this.value)}function b(){let e=this.parentElement.parentElement;v.removeWaveform(Number(e.id)),c.removeChild(e)}w.addEventListener("noteOn",E),w.addEventListener("noteOff",g),window.addEventListener("click",(function e(){p.resume().then((()=>{console.log("Audio context resumed successfully"),window.removeEventListener("click",e)}))})),o.addEventListener("change",(function(){f.setSelectedInput(o.value)})),r.addEventListener("click",(function(){let e=c.lastElementChild,t=function(e){let t=document.createElement("tr");t.id=e.toString();let s=document.createElement("td"),n=document.createElement("select");(function(e){let t=["square","sawtooth","triangle","sine"];for(let s of t){let t=document.createElement("option");t.text=s,t.value=s,e.add(t)}})(n),n.addEventListener("change",C),s.append(n);let i=document.createElement("td"),a=document.createElement("input");a.type="range",a.min="0",a.max="1",a.step="0.01",a.value="0.5",a.addEventListener("change",I),i.append(a);let o=document.createElement("td"),r=document.createElement("input");r.type="range",r.min="0",r.max="1",r.step="0.01",r.value="0",r.addEventListener("change",x),o.append(r);let c=document.createElement("td"),h=document.createElement("button");return h.appendChild(document.createTextNode("remove")),h.addEventListener("click",b),c.append(h),t.appendChild(s),t.appendChild(i),t.appendChild(o),t.appendChild(c),t}(e?Number(e.id)+1:0);c.appendChild(t),v.addWaveform(Number(t.id),{type:"square",volume:.5,delay:0})})),d.addEventListener("change",I),l.addEventListener("change",(function(){v.setCompressorOn(this.checked)})),m.addEventListener("change",(function(){this.checked?(v.setDestination(y.analyser),y.setDestination(),y.drawStart(),u.hidden=!1):(y.drawStop(),y.disconnect(),v.setDestination(p.destination),u.hidden=!0)}))})();